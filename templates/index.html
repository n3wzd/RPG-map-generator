{% import 'input.html' as input %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Map Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="sidebar">
        <h2>Parameters</h2>
        <form action="/submit" method="post" id="parameter-form">
            <div class="select-container">
                <label for="map_type">Map Type</label>
                <select id="map_type" name="map_type">
                      <option value="0">Dungeon</option>
                      <option value="1">Cave</option>
                      <option value="2">Plain</option>
                      <option value="3">Field</option>
                </select>
            </div>
            {{ input.field('map_width', 'Map Width', '10', '300', '48') }}
            {{ input.field('map_height', 'Map Height', '10', '300', '48') }}
            {{ input.slider('map_padding', 'Map Padding', '0', '9', '4') }}
            {{ input.slider('wall_height', 'Wall Height', '1', '9', '2') }}

            {{ input.range('room_min_size', 'room_max_size', 'Room Min Size', 'Room Max Size', '4', '20', '4', '20') }}
            {{ input.slider('corridor_wide', 'Corridor Wide', '1', '3', '2') }}
            <button id="submit_button" type="submit">Generate</button>
        </form>
    </div>
    <div class="main-content">
        <div id="map">
            <img id="result-image" src="" style="display: none;" >
            <div id="img-loading-text">press generate button to create map!</div>
        </div>
    </div>

    <script>
        function getElement(id) {
            return document.getElementById(id)
        }
        function getElementValue(id) {
            return getElement(id).value
        }
        
        getElement('parameter-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const submitButton = getElement('submit_button');
            submitButton.disabled = true;
            submitButton.innerText = 'Generating...';

            const resultImage = getElement('result-image');
            resultImage.style.display = 'none';

            const loadingText = getElement('img-loading-text');
            loadingText.style.display = 'block';
            loadingText.innerText = 'Generating...';
            
            const map_width = getElementValue('map_width');
            const map_height = getElementValue('map_height');
            const map_type = getElementValue('map_type');
            const map_padding = getElementValue('map_padding');
            const wall_height = getElementValue('wall_height');

            fetch('/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'map_width': map_width,
                    'map_height': map_height,
                    'map_padding': map_padding,
                    'map_type': map_type,
                    'wall_height': wall_height,
                })
            })
            .then(response => response.json())
            .then(data => {
                const resultImage = getElement('result-image');
                resultImage.src = data.img_path + '?t=' + new Date().getTime();
                
                submitButton.disabled = false;
                submitButton.innerText = 'Generate';

                resultImage.style.display = 'block';
                loadingText.style.display = 'none';
            })
            .catch(error => console.error('Error:', error));
        });
        
        function updateInput(paramId) {
            const paramValue = getElement(paramId).value;
            document.getElementById(paramId + '_value').textContent = paramValue;

            if(paramId === "map_width" || paramId === "map_height" || paramId === "map_padding") {
                getElement("room_min_size").max = Math.min(getElementValue(), 
                        getElementValue("map_height")) - 
                        getElementValue("map_padding");
                getElement("room_max_size").max = Math.min(getElementValue(), 
                        getElementValue("map_height")) - 
                        getElementValue("map_padding");
            }
            if(paramId === "room_min_size" || paramId === "wall_height") {
                getElement("corridor_wide").max = 
                    Math.floor((getElementValue("room_min_size") - getElementValue("wall_height")) / 2);
            }
        }
        
        function updateRangeInput(paramId1, paramId2, caller) {
            const minValue = parseInt(getElementValue(paramId1));
            const maxValue = parseInt(getElementValue(paramId2));
            if(minValue > maxValue) {
                if(caller === 1) {
                    getElement(paramId2).value = minValue;
                } else {
                    getElement(paramId1).value = maxValue;
                }
            }
            updateInput(paramId1);
            updateInput(paramId2);
        }

        updateInput("room_max_size")
        updateInput("corridor_wide")
    </script>
</body>
</html>